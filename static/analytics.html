<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - I.T. PAL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .navbar {
            background: linear-gradient(135deg, #1b7ca8 0%, #155a7a 100%);
        }
        .btn-primary {
            background: #1b7ca8;
            border-color: #1b7ca8;
        }
        .btn-primary:hover {
            background: #155a7a;
            border-color: #155a7a;
        }
        .stat-card {
            border-left: 4px solid #1b7ca8;
        }
        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            color: #1b7ca8;
            margin: 0;
        }
        .stat-card p {
            color: #6c757d;
            margin: 0.5rem 0 0 0;
        }
        .change-positive {
            color: #198754;
        }
        .change-negative {
            color: #dc3545;
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        .year-selector {
            max-width: 150px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <img src="/static/logo.png" alt="I.T. PAL" style="max-height: 50px;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/invoices"><i class="bi bi-file-earmark-text"></i> Invoices</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/quotes"><i class="bi bi-file-earmark-ruled"></i> Quotes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/receipts"><i class="bi bi-receipt"></i> Receipts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/projects"><i class="bi bi-folder"></i> Projects</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/customers"><i class="bi bi-people"></i> Customers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analytics"><i class="bi bi-graph-up"></i> Analytics</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm ms-3" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-graph-up"></i> Analytics</h2>
            <select id="yearSelector" class="form-select year-selector" onchange="updateCharts()">
            </select>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card shadow-sm">
                    <div class="card-body">
                        <h3 id="totalIssuedAmount">€0</h3>
                        <p><i class="bi bi-currency-euro"></i> Total Issued Revenue</p>
                        <small class="text-muted"><span id="totalIssuedCount">0</span> invoices</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm">
                    <div class="card-body">
                        <h3 id="currentMonthTotal">€0</h3>
                        <p><i class="bi bi-calendar-month"></i> This Month</p>
                        <small id="monthChange"></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm">
                    <div class="card-body">
                        <h3 id="currentYearTotal">€0</h3>
                        <p><i class="bi bi-calendar"></i> This Year</p>
                        <small id="yearChange"></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm">
                    <div class="card-body">
                        <h3 id="totalDraftAmount">€0</h3>
                        <p><i class="bi bi-file-earmark"></i> Pending (Drafts)</p>
                        <small class="text-muted"><span id="totalDraftCount">0</span> invoices</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Monthly Revenue (<span id="selectedYearTitle">2025</span>)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Invoice Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Year Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="yearComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calendar-range"></i> Monthly Trend</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Monthly Breakdown (<span id="selectedYearTable">2025</span>)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Invoices</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">Avg per Invoice</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTable">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th>Total</th>
                                <th class="text-end" id="tableTotalCount">0</th>
                                <th class="text-end" id="tableTotalRevenue">€0</th>
                                <th class="text-end" id="tableTotalAvg">€0</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <h3 class="mt-5 mb-4"><i class="bi bi-folder"></i> Project Analytics</h3>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #28a745;">
                    <div class="card-body">
                        <h3 id="activeProjectsCount" style="color: #28a745;">0</h3>
                        <p><i class="bi bi-folder-fill"></i> Active Projects</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #6c757d;">
                    <div class="card-body">
                        <h3 id="totalProjectsCount" style="color: #6c757d;">0</h3>
                        <p><i class="bi bi-folder"></i> Total Projects</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #17a2b8;">
                    <div class="card-body">
                        <h3 id="closedProjectsCount" style="color: #17a2b8;">0</h3>
                        <p><i class="bi bi-folder-check"></i> Closed Projects</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #1b7ca8;">
                    <div class="card-body">
                        <h3 id="projectRevenueTotal">€0</h3>
                        <p><i class="bi bi-currency-euro"></i> Project Revenue</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> Top Projects by Revenue</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="topProjectsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-steps"></i> Milestone Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="milestoneChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Top Projects Details</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Project Code</th>
                                <th>Title</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th class="text-end">Budget</th>
                                <th class="text-end">Invoiced</th>
                                <th class="text-end">Budget Used</th>
                            </tr>
                        </thead>
                        <tbody id="topProjectsTable">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h3 class="mt-5 mb-4"><i class="bi bi-receipt"></i> Receipt Analytics</h3>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #28a745;">
                    <div class="card-body">
                        <h3 id="receiptIssuedCount" style="color: #28a745;">0</h3>
                        <p><i class="bi bi-receipt"></i> Issued Receipts</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #ffc107;">
                    <div class="card-body">
                        <h3 id="receiptDraftCount" style="color: #ffc107;">0</h3>
                        <p><i class="bi bi-receipt-cutoff"></i> Draft Receipts</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #28a745;">
                    <div class="card-body">
                        <h3 id="receiptTotalAmount" style="color: #28a745;">€0</h3>
                        <p><i class="bi bi-cash-coin"></i> Total Received</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card shadow-sm" style="border-left-color: #17a2b8;">
                    <div class="card-body">
                        <h3 id="receiptMonthTotal" style="color: #17a2b8;">€0</h3>
                        <p><i class="bi bi-calendar-check"></i> This Month</p>
                        <small id="receiptMonthChange"></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Monthly Cashflow</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="cashflowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Payment Methods Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="paymentMethodsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
        if (!checkAuth()) {
            window.location.href = '/login';
        }

        let analyticsData = null;
        let projectAnalyticsData = null;
        let receiptAnalyticsData = null;
        let monthlyChart = null;
        let statusChart = null;
        let yearComparisonChart = null;
        let trendChart = null;
        let topProjectsChart = null;
        let milestoneChart = null;
        let cashflowChart = null;
        let paymentMethodsChart = null;

        const chartColors = {
            primary: '#1b7ca8',
            secondary: '#155a7a',
            success: '#198754',
            warning: '#ffc107',
            danger: '#dc3545',
            light: '#f8f9fa',
            primaryAlpha: 'rgba(27, 124, 168, 0.7)',
            secondaryAlpha: 'rgba(21, 90, 122, 0.7)'
        };

        async function loadAnalytics() {
            try {
                const token = localStorage.getItem('token');
                const [analyticsResponse, projectResponse, receiptResponse] = await Promise.all([
                    fetch('/api/analytics', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/analytics/projects', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/analytics/receipts', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                if (!analyticsResponse.ok) throw new Error('Failed to load analytics');
                
                analyticsData = await analyticsResponse.json();
                if (projectResponse.ok) {
                    projectAnalyticsData = await projectResponse.json();
                }
                if (receiptResponse.ok) {
                    receiptAnalyticsData = await receiptResponse.json();
                }
                
                updateDisplay();
                initializeCharts();
                if (projectAnalyticsData) {
                    updateProjectDisplay();
                    initializeProjectCharts();
                }
                if (receiptAnalyticsData && receiptAnalyticsData.total_issued_receipts !== undefined) {
                    updateReceiptDisplay();
                    initializeReceiptCharts();
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        function updateProjectDisplay() {
            document.getElementById('activeProjectsCount').textContent = projectAnalyticsData.active_projects;
            document.getElementById('totalProjectsCount').textContent = projectAnalyticsData.total_projects;
            document.getElementById('closedProjectsCount').textContent = projectAnalyticsData.closed_projects;
            document.getElementById('projectRevenueTotal').textContent = `€${projectAnalyticsData.total_project_revenue.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        function initializeProjectCharts() {
            if (!projectAnalyticsData) return;
            
            const topProjects = projectAnalyticsData.top_projects.slice(0, 5);
            
            if (topProjectsChart) topProjectsChart.destroy();
            const topProjectsCtx = document.getElementById('topProjectsChart').getContext('2d');
            topProjectsChart = new Chart(topProjectsCtx, {
                type: 'bar',
                data: {
                    labels: topProjects.map(p => p.project_code),
                    datasets: [{
                        label: 'Revenue (€)',
                        data: topProjects.map(p => p.invoiced_total),
                        backgroundColor: chartColors.primaryAlpha,
                        borderColor: chartColors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            const milestones = projectAnalyticsData.milestone_progress.slice(0, 10);
            
            if (milestoneChart) milestoneChart.destroy();
            const milestoneCtx = document.getElementById('milestoneChart').getContext('2d');
            milestoneChart = new Chart(milestoneCtx, {
                type: 'bar',
                data: {
                    labels: milestones.map(m => `${m.project_code} #${m.milestone_no}`),
                    datasets: [
                        {
                            label: 'Expected',
                            data: milestones.map(m => m.expected_amount),
                            backgroundColor: 'rgba(108, 117, 125, 0.3)',
                            borderColor: '#6c757d',
                            borderWidth: 1
                        },
                        {
                            label: 'Invoiced',
                            data: milestones.map(m => m.invoiced_amount),
                            backgroundColor: chartColors.success + '99',
                            borderColor: chartColors.success,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            updateTopProjectsTable();
        }
        
        function updateTopProjectsTable() {
            const tbody = document.getElementById('topProjectsTable');
            if (!projectAnalyticsData || projectAnalyticsData.top_projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No projects found</td></tr>';
                return;
            }
            
            let html = '';
            projectAnalyticsData.top_projects.slice(0, 10).forEach(project => {
                const statusBadge = project.status === 'active' ? 'bg-success' : 
                                   project.status === 'closed' ? 'bg-secondary' : 'bg-danger';
                const customerName = project.company_name || project.customer_name || '-';
                const budgetUsed = project.budget_utilization !== null ? 
                    `${project.budget_utilization}%` : '-';
                
                html += `
                    <tr>
                        <td><a href="/projects/view/${project.project_id}">${project.project_code}</a></td>
                        <td>${project.title}</td>
                        <td>${customerName}</td>
                        <td><span class="badge ${statusBadge}">${project.status}</span></td>
                        <td class="text-end">€${project.budget.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td class="text-end">€${project.invoiced_total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td class="text-end">${budgetUsed}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        function updateReceiptDisplay() {
            if (!receiptAnalyticsData) return;
            
            document.getElementById('receiptIssuedCount').textContent = receiptAnalyticsData.total_issued_receipts;
            document.getElementById('receiptDraftCount').textContent = receiptAnalyticsData.total_draft_receipts;
            document.getElementById('receiptTotalAmount').textContent = `€${receiptAnalyticsData.total_issued_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('receiptMonthTotal').textContent = `€${receiptAnalyticsData.current_month_total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            
            const monthChange = document.getElementById('receiptMonthChange');
            if (receiptAnalyticsData.month_change_percent !== null) {
                const isPositive = receiptAnalyticsData.month_change_percent >= 0;
                monthChange.className = isPositive ? 'change-positive' : 'change-negative';
                monthChange.innerHTML = `<i class="bi bi-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(receiptAnalyticsData.month_change_percent)}% vs last month`;
            } else {
                monthChange.textContent = 'No previous month data';
                monthChange.className = 'text-muted';
            }
        }
        
        function initializeReceiptCharts() {
            if (!receiptAnalyticsData) return;
            
            if (cashflowChart) cashflowChart.destroy();
            const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
            cashflowChart = new Chart(cashflowCtx, {
                type: 'line',
                data: {
                    labels: receiptAnalyticsData.monthly_cashflow.map(m => m.month_name.substring(0, 3)),
                    datasets: [{
                        label: 'Cashflow (€)',
                        data: receiptAnalyticsData.monthly_cashflow.map(m => m.total),
                        borderColor: chartColors.success,
                        backgroundColor: chartColors.success + '33',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            const paymentMethods = receiptAnalyticsData.payment_methods_breakdown;
            const methodLabels = {
                'cash': 'Cash',
                'bank_transfer': 'Bank Transfer',
                'card': 'Card',
                'cheque': 'Cheque',
                'other': 'Other'
            };
            const methodColors = ['#28a745', '#1b7ca8', '#6f42c1', '#ffc107', '#6c757d'];
            
            if (paymentMethodsChart) paymentMethodsChart.destroy();
            const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
            paymentMethodsChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: paymentMethods.map(pm => methodLabels[pm.method] || pm.method),
                    datasets: [{
                        data: paymentMethods.map(pm => pm.total),
                        backgroundColor: methodColors.slice(0, paymentMethods.length),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const pm = paymentMethods[context.dataIndex];
                                    return `${context.label}: €${pm.total.toLocaleString('en-US', {minimumFractionDigits: 2})} (${pm.percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDisplay() {
            document.getElementById('totalIssuedAmount').textContent = `€${analyticsData.total_issued_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('totalIssuedCount').textContent = analyticsData.total_issued_invoices;
            document.getElementById('totalDraftAmount').textContent = `€${analyticsData.total_draft_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('totalDraftCount').textContent = analyticsData.total_draft_invoices;
            document.getElementById('currentMonthTotal').textContent = `€${analyticsData.current_month_total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('currentYearTotal').textContent = `€${analyticsData.current_year_total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            const monthChange = document.getElementById('monthChange');
            if (analyticsData.month_change_percent !== null) {
                const isPositive = analyticsData.month_change_percent >= 0;
                monthChange.className = isPositive ? 'change-positive' : 'change-negative';
                monthChange.innerHTML = `<i class="bi bi-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(analyticsData.month_change_percent)}% vs last month`;
            } else {
                monthChange.textContent = 'No previous month data';
                monthChange.className = 'text-muted';
            }

            const yearChange = document.getElementById('yearChange');
            if (analyticsData.year_change_percent !== null) {
                const isPositive = analyticsData.year_change_percent >= 0;
                yearChange.className = isPositive ? 'change-positive' : 'change-negative';
                yearChange.innerHTML = `<i class="bi bi-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(analyticsData.year_change_percent)}% vs last year`;
            } else {
                yearChange.textContent = 'No previous year data';
                yearChange.className = 'text-muted';
            }

            const yearSelector = document.getElementById('yearSelector');
            yearSelector.innerHTML = '';
            analyticsData.available_years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            });
        }

        function initializeCharts() {
            const selectedYear = parseInt(document.getElementById('yearSelector').value);
            const yearData = analyticsData.yearly_data.find(y => y.year === selectedYear);
            
            document.getElementById('selectedYearTitle').textContent = selectedYear;
            document.getElementById('selectedYearTable').textContent = selectedYear;

            if (monthlyChart) monthlyChart.destroy();
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: yearData.monthly_data.map(m => m.month_name.substring(0, 3)),
                    datasets: [{
                        label: 'Revenue (€)',
                        data: yearData.monthly_data.map(m => m.total),
                        backgroundColor: chartColors.primaryAlpha,
                        borderColor: chartColors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            if (statusChart) statusChart.destroy();
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Issued', 'Draft'],
                    datasets: [{
                        data: [analyticsData.total_issued_invoices, analyticsData.total_draft_invoices],
                        backgroundColor: [chartColors.success, chartColors.warning],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            if (yearComparisonChart) yearComparisonChart.destroy();
            const yearCompCtx = document.getElementById('yearComparisonChart').getContext('2d');
            yearComparisonChart = new Chart(yearCompCtx, {
                type: 'bar',
                data: {
                    labels: analyticsData.yearly_data.map(y => y.year).reverse(),
                    datasets: [{
                        label: 'Annual Revenue (€)',
                        data: analyticsData.yearly_data.map(y => y.total).reverse(),
                        backgroundColor: chartColors.primaryAlpha,
                        borderColor: chartColors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            if (trendChart) trendChart.destroy();
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const datasets = analyticsData.yearly_data.slice(0, 3).map((year, index) => ({
                label: year.year.toString(),
                data: year.monthly_data.map(m => m.total),
                borderColor: index === 0 ? chartColors.primary : (index === 1 ? chartColors.secondary : chartColors.warning),
                backgroundColor: 'transparent',
                tension: 0.3,
                borderWidth: 2
            }));
            
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            updateTable(yearData);
        }

        function updateTable(yearData) {
            const tbody = document.getElementById('monthlyTable');
            let html = '';
            let totalCount = 0;
            let totalRevenue = 0;

            yearData.monthly_data.forEach(month => {
                const avg = month.count > 0 ? month.total / month.count : 0;
                totalCount += month.count;
                totalRevenue += month.total;
                html += `
                    <tr>
                        <td>${month.month_name}</td>
                        <td class="text-end">${month.count}</td>
                        <td class="text-end">€${month.total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td class="text-end">€${avg.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById('tableTotalCount').textContent = totalCount;
            document.getElementById('tableTotalRevenue').textContent = `€${totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('tableTotalAvg').textContent = totalCount > 0 ? `€${(totalRevenue / totalCount).toLocaleString('en-US', {minimumFractionDigits: 2})}` : '€0';
        }

        function updateCharts() {
            if (!analyticsData) return;
            
            const selectedYear = parseInt(document.getElementById('yearSelector').value);
            const yearData = analyticsData.yearly_data.find(y => y.year === selectedYear);
            
            if (!yearData) return;

            document.getElementById('selectedYearTitle').textContent = selectedYear;
            document.getElementById('selectedYearTable').textContent = selectedYear;

            monthlyChart.data.datasets[0].data = yearData.monthly_data.map(m => m.total);
            monthlyChart.update();

            updateTable(yearData);
        }

        loadAnalytics();
    </script>
</body>
</html>
